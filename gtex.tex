\directlua{dofile('gtex.lua')}

\def\trim#1{\directlua{
    local path = [[#1]]
    tex.print(string.gsub(path, "\%s", ""))
}}

\def\_includett#1{\directlua{includett([[#1]], true)}}

\def\includett{\scantoeol\_includett}

\def\_gscriptpath{\jobname.scm}
\def\_grespath{\jobname.inp}
\newread\_gscript
% \openout\_gscript=\_gscriptpath
% \newread\_gres
% \openin\_gres=\_grespath
\isfile\_gscriptpath\iffalse\opwarning{
The auxiliary file \_gscriptpath was created,
you can use `guix build -f \_gscriptpath -r \_grespath` to update this document's dependencies.
}\fi

% \def\guix#1#2{\write\_gscript{#1:#2}}
\def\guix#1#2{\directlua{guix([[#1]], [[#2]])}}
\def\guixref#1{\directlua{guixref([[#1]])}}

\directlua{load_guixrefs([[\_grespath]])}

\def\_remotefile#1#2{
(let ((h ((@ (guix base64) base64-decode) "#2")))
  ((@ (guix download) origin)
    (uri "#1")
    (method (@ (guix download) url-fetch))
    (sha256 h)))
}
\def\remotefile#1#2#3{\guix{#1}{\_remotefile{#2}{#3}}}

\def\insapdownscale{0.8}
\def\insappic#1{%
  \vfil%
  \hbox to \hsize{%
    \hfil%
    \directlua{insertAPImage("#1", \insapdownscale)}%
    \hfil%
  }%
  \vfil
}

\def\maybeinspic#1{%
  \isfile{\guixref{#1}}%
  \iftrue\insappic{\guixref{#1}}%
  \else#1:??%
  \fi%
}

\def\rinspic#1#2#3{%
  \remotefile{#1}{#2}{#3}%
  \maybeinspic{#1}%
}

\def\eval#1#2{((@ (gtex) eval-script) "#1" #2)}
\def\feval#1#2#3{((@ (gtex) eval-script) "#2" #3 "#1")}

\newcount\gtexline

\def\gtexgraphvizid{graphviz\the\gtexline}
\def\graphviz#1{
  \global\advance\gtexline by 1
  \guix{\gtexgraphvizid}%
  {\feval{dot.png}{graphviz/bin/dot -Tpng}{%
      \textfile{dot.dot}{#1}}}

  \maybeinspic{\gtexgraphvizid}
}

\def\textfile#1#2{((@ (guix gexp) mixed-text-file) "#1" "#2")}

\def\printer#1{(display #1)}
\def\evaluator{guile}

\def\gtexlineid{\evaluator\the\gtexline}

\def\showline#1{%
  \global\advance\gtexline by 1
  \guix{\gtexlineid}{\eval{\evaluator}{\textfile{\gtexlineid}{\printer{#1}}}}%

  {\_ttfont
    #1 => \directlua{includett([[\guixref{\gtexlineid}]])}}
}
